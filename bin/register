#!/usr/bin/python3

import sys
import os
import socket
import re

from utilities import *


def usage ():
    print('Usage: register NODE', file=sys.stderr)
    print('   Create and register a node.', file=sys.stderr)
    node_usage()
    exit(1)



if len(sys.argv) != 2:
    print('Incorrect number of arguments.', file=sys.stderr)
    usage()


if not os.path.exists(os.path.join(SYSDISTRIBUTED, 'key')):
    print("Generating public/private keypair.")
    execute('ssh-keygen',
        '-t', 'rsa',
        '-b', '2048',
        '-f', os.path.join(SYSDISTRIBUTED, 'key'),
        '-N', '').wait()


node = sys.argv[1]
address = decode_node(node)
if not address:
    print('Invalid node address.', file=sys.stderr)
    usage()
user, host, port, directory = address


def ensure (truth):
    if not truth:
        print('Failure!')
        exit(1)


# Must check if the remote server is reachable, because otherwise
# ssh-copy-id just hangs for a long time without giving an error.
# Obviously, the server could go down in between this check and
# running ssh-copy-id, but this should fix the majority of cases,
# and at any rate a human should be running this script manually
# anyway, so can act as their own timeout.
print("Checking if remote server is reachable ...")
sock = socket.socket()
sock.settimeout(5)
try:
    sock.connect((host, int(port)))
    ensure(
        sock.recv(100).lower().startswith(b'ssh')
    )
except socket.timeout:
    ensure(False)
finally:
    sock.close()


print("Registering public key with remote server ...")
ensure(
    execute('ssh-copy-id',
        '-i', os.path.join(SYSDISTRIBUTED, 'key.pub'),
        '-p', str(port),
        '%s@%s' % (user, host)
    ).wait() == 0
)

print("Testing if key registration worked ...")
ensure(
    execute('ssh',
        '-i', os.path.join(SYSDISTRIBUTED, 'key'),
        '-p', str(port),
        '%s@%s' % (user, host),
        '-o', 'PreferredAuthentications=publickey',
        '-o', 'IdentitiesOnly=yes',
        'true'
    ).wait() == 0
)


print("Copying private key ...")
copy_to_node(node, '$SYSDISTRIBUTED/key',
    open(os.path.join(SYSDISTRIBUTED, 'key')), '600')
print("Copying public key ...")
copy_to_node(node, '$SYSDISTRIBUTED/key.pub',
    open(os.path.join(SYSDISTRIBUTED, 'key.pub')))

print("Copying sysdistributed ...")
copy_to_node(node, '$SYSDISTRIBUTED/sysdistributed',
    open(os.path.join(SYSDISTRIBUTED, 'sysdistributed')))

files = os.listdir(os.path.join(SYSDISTRIBUTED, 'bin'))
files = [fname for fname in files if re.match(r'^[a-zA-Z\-]+$', fname) != None]

for fname in files:
    print("Copying", fname, '...')
    path = os.path.join(SYSDISTRIBUTED, 'bin', fname)
    copy_to_node(node, '$SYSDISTRIBUTED/bin/' + fname, open(path))


print("Success!")
exit(0)


